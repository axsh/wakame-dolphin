#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'rubygems'
require 'bundler/setup'
require File.join(File.expand_path('../../', __FILE__), 'lib/dolphin')

module Dolphin
  def self.run

    if RUBY_VERSION.to_f >= 2
      # Celluloid::TaskFiber by default
    elsif RUBY_VERSION.to_f >= 1.9
      Celluloid.task_class = Celluloid::TaskThread
    else
      raise "Doesn't support ruby version: #{RUBY_VERSION}"
      exit!
    end

    manager = Manager.new
    # manager.pool(Worker, :as => :workers, :size => 2)
    # manager.pool(Sender::Mail, :as => :mail_senders, :size => 2)
    # manager.pool(QueryProcessor, :as => :query_processors, :size => 2)

    manager.add(Worker, :as => :workers)
    manager.add(Sender::Mail, :as => :mail_senders)
    manager.add(QueryProcessor, :as => :query_processors)

    server_settings = Dolphin.settings['server']

    # TODO: RequestHandler link to Manager
    # TODO: Chanage to rackup
    RequestHandler.new(server_settings['host'], server_settings['port'])


    Manager.run
  end
end

Dolphin.run
sleep
